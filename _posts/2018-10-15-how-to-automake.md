---
layout: post
title:  "如何使用 Automake 生成 Makefile"
date:   2018-10-15 15:10:52 +0800
author: mistydew
comments: true
categories: Makefile
tags: C C++ Automake
---
使用 make 编译工具链构建项目的简单过程。

## 必备工具

* autoscan
* aclocal
* autoheader
* autoconf
* automake

## 0. 编写源码

下面是一个 C++ 例子，意在向终端输出一串字符。<br>
这里分为 2 个文件：头文件 main.h 和源文件 main.cc，放在同一目录 src 下。

头文件 main.h：

{% highlight C++ %}
#include <iostream>
{% endhighlight %}

源文件 main.cc（configure.ac 默认只识别 main 关键字命名的文件）：

{% highlight C++ %}
#include "main.h"

int main(void)
{
	std::cout << "This program generated by Automake." << std::endl;

	return 0;
}
{% endhighlight %}

## 1. 修改 configure.ac（旧版格式为 .in，已过时，新版不兼容）

进入 src 目录，使用 autoscan 扫描源码结构。

{% highlight shell %}
$ src
$ autoscan
{% endhighlight %}

这里会生成 autoscan.log 和 configure.scan 两个文件，修改 configure.scan 作为 configure.ac。

{% highlight shell %}
$ mv configure.scan configure.ac
$ vim configure.ac
{% endhighlight %}

打开 configure.ac 做以下修改。

{% highlight C++ %}
#                                               -*- Autoconf -*-
# Process this file with autoconf to produce a configure script.

AC_PREREQ([2.69])
-AC_INIT([FULL-PACKAGE-NAME], [VERSION], [BUG-REPORT-ADDRESS])
+AC_INIT([main], [1.0], [mistydew@qq.com]) # 初始化包名，版本号，bug 报告邮箱
AC_CONFIG_SRCDIR([main.cc])
AC_CONFIG_HEADERS([config.h])

+AM_INIT_AUTOMAKE # 表示使用 Automake 生成 Makefile

# Checks for programs.
AC_PROG_CXX
AC_PROG_CC

# Checks for libraries.

# Checks for header files.

# Checks for typedefs, structures, and compiler characteristics.

# Checks for library functions.

-AC_OUTPUT
+AC_OUTPUT(Makefile) # 指定输出文件名为 Makefile
{% endhighlight %}

## 2. 生成 configure, config.h.in, autom4te.cache 等文件

运行以下命令，顺序不固定。

{% highlight shell %}
$ aclocal # 生成 autom4te.cache 目录
$ autoheader # 生成 config.h.in 文件
$ autoconf # 生成 configure 文件
{% endhighlight %}

## 3. 编写 Makefile.am

{% highlight shell %}
$ vim Makefile.am
{% endhighlight %}

{% highlight C++ %}
AUTOMAKE_OPTIONS=foreign

bin_PROGRAMS=main # 指定生成的 ELF 文件名

main_SOURCES=main.cc # 指定 main 函数所在的源文件
{% endhighlight %}

## 4. 生成 Makefile.in

使用 automake 生成 Makefile.in 文件。

{% highlight C++ %}
$ automake --add-missing
{% endhighlight %}

**注：--add-missing 选项会添加丢失的必备的文件。**

## 5. 生成 Makefile

执行上面生成的 configure 文件，得到 Makefile。

{% highlight C++ %}
$ ./configure
{% endhighlight %}

## 6. make 构建源码

使用 make 命令得到可执行程序 main。

{% highlight C++ %}
$ make
{% endhighlight %}

Thanks for your time.

## 参照
* [algorithms/automake_help.md at master · luofengmacheng/algorithms](https://github.com/luofengmacheng/algorithms/blob/master/myalgo/automake_help.md)
* [概念：GNU构建系统和Autotool](http://www.pchou.info/linux/2016/09/16/gnu-build-system-1.html)
* [...]({{ site.url | append: site.blog }})
