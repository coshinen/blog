---
layout: post
title:  "比特币中的洋葱路由"
date:   2018-09-10 16:50:30 +0800
author: mistydew
categories: Bitcoin Tor
tags: 比特币 洋葱路由
---
洋葱路由 `Tor(The onion router)` 是一个分布式的“洋葱”网络，它使追踪网络上任何一个对端节点变得更加困难。
同时，`Tor` 对于访问中国和伊朗等国家的“未经审查的”网络非常有用。
保护隐私不仅意味着隐藏消息内容，而且还隐藏交流对象（流量分析）。
`Tor` 提供匿名连接，对窃听和流量分析都有很强的抵抗力。
简单的说，`Tor` 可以使用户增加匿名性，即防止追踪的能力。

比特币可以在 `Tor` 网络上轻松的运行。

# Tor 是如何工作的

不像 `Freenet`，`I2P` 等，`Tor` 的安全性非常明确。
虽然确实存在弱点（如下所述），但自 `Tor` 出现以来就为人所知，并且预计不会出现新的重要缺陷。

`Tor` 通过 3 个（普通）或 7 个（隐藏服务）中继发送 `TCP` 数据包。
这就是它速度慢的原因：你的数据包可能不得不通过 100 台计算机（包括网络路由）才能到达目的地。
`Tor` 为每个节点使用多层加密。

假设我想通过 `Tor` 连接到 `bitcoin.org`。首先我选择了 3 个我知道的 `Tor` 中继。
然后，我向我的 `ISP` 发送一条信息，如下所示：

> 发送到该 IP：<中继 1 的 IP><br>
> <中继 1 加密的数据>

当中继 1 收到该数据时，使用其私钥解密有效载荷（ `payload`），即附带的内容。有效载荷包含：

> 发送到该 Tor 节点：<中继 2><br>
> <中继 2 加密的数据>

中继 2 解密其有效载荷：

> 发送到该 Tor 节点：<中继 3><br>
> <中继 3 加密的数据>

中继 3 收到真正的 `TCP` 有效载荷，并将其发送到目的地：

> 发送到该 IP：<目的地 IP><br>
> <未加密的有效载荷>

`Tor` 没有也无法对该有效载荷进一步加密。但是，如果协议本身使用加密（`HTTPS`, `SSH` 等），则数据将被加密。
这意味着最后一个节点（出口节点）可以看到你在 `HTTP` 站点上执行的所有操作，并且如果密码是未加密的，则会被窃取。
许多人称为出口节点只是为了能看到这些信息—`Tor` 比开放的 `WIFI` 更危险！

上述的加密安排确保没有单个 `Tor` 节点直到发送者和目的地。
中继 1 和你的 `ISP` 都直到你正在使用的 `Tor` 和在确定时间发送的数据包，但它们不知道你发送的内容或你要发送给谁。
中继 3 确切地知道你发送的内容，但它无法确定是谁发送的，因为中继 2 和中继 1 阻止它发现。
所有 3 个中继需要协同工作才能最终连接发送方和目的地。

然而，`Tor` 对定时攻击很弱，只允许两个参与者在某些位置以高精度确定发送者。考虑下这个 `Tor` 连接：

> 发送者 <-> S-ISP <-> 中继 1 <-> 中继 2 <-> 中继 3 <-> D-ISP <-> 目的地

如果发送方 `ISP(S-ISP)` 和目的地一起工作，它们可以记录发送和接收的数据包的大小和时间。
在大量数据包上，它们能够非常精准地确定发送方，实际上，是把数据包发送到目的地的人。
这需要双方进行主动监视或详细记录。
中继 1 也能执行与 `S-ISP` 相同的角色。

（未完成）

Thanks for your time.

## 参照
* [Tor - Bitcoin WiKi](https://en.bitcoin.it/wiki/Tor#How_Tor_works)
* [Setting up a Tor hidden service - Bitcoin Wiki](https://en.bitcoin.it/wiki/Setting_up_a_Tor_hidden_service)
* [bitcoin/bitcoin v0.12.1](https://github.com/bitcoin/bitcoin/tree/v0.12.1)
* [...](https://github.com/mistydew/blockchain)
