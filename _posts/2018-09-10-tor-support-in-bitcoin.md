---
layout: post
title:  "比特币中的洋葱路由"
date:   2018-09-10 16:50:30 +0800
author: mistydew
categories: Bitcoin 译文
tags: Tor 比特币
---
洋葱路由 Tor(The onion router) 是一个分布式的“洋葱”网络，它使追踪网络上任何一个对端节点变得更加困难。
同时，Tor 对于访问中国和伊朗等国家的“未经审查的”网络非常有用。
保护隐私不仅意味着隐藏消息内容，而且还隐藏交流对象（流量分析）。
Tor 提供匿名连接，对窃听和流量分析都有很强的抵抗力。
简单的说，Tor 可以使用户增加匿名性，即防止追踪的能力。

比特币可以在 Tor 网络上轻松的运行。

# Tor 是如何工作的

不像 Freenet，I2P 等，Tor 的安全性非常明确。
虽然确实存在弱点（如下所述），但自 Tor 出现以来就为人所知，并且预计不会出现新的重要缺陷。

Tor 通过 3 个（普通）或 7 个（隐藏服务）中继发送 TCP 数据包。
这就是它速度慢的原因：你的数据包可能不得不通过 100 台计算机（包括网络路由）才能到达目的地。
Tor 为每个节点使用多层加密。

假设我想通过 Tor 连接到 bitcoin.org。首先我选择了 3 个我知道的 Tor 中继。
然后，我向我的 ISP 发送一条信息，如下所示：

> 发送到该 IP：<中继 1 的 IP><br>
> <中继 1 加密的数据>

当中继 1 收到该数据时，使用其私钥解密有效载荷（ payload），即附带的内容。有效载荷包含：

> 发送到该 Tor 节点：<中继 2><br>
> <中继 2 加密的数据>

中继 2 解密其有效载荷：

> 发送到该 Tor 节点：<中继 3><br>
> <中继 3 加密的数据>

中继 3 收到真正的 TCP 有效载荷，并将其发送到目的地：

> 发送到该 IP：<目的地 IP><br>
> <未加密的有效载荷>

Tor 没有也无法对该有效载荷进一步加密。但是，如果协议本身使用加密（HTTPS, SSH 等），则数据将被加密。
这意味着最后一个节点（出口节点）可以看到你在 HTTP 站点上执行的所有操作，并且如果密码是未加密的，则会被窃取。
许多人称为出口节点只是为了能看到这些信息—Tor 比开放的 WIFI 更危险！

上述的加密安排确保没有单个 Tor 节点直到发送者和目的地。
中继 1 和你的 ISP 都直到你正在使用的 Tor 和在确定时间发送的数据包，但它们不知道你发送的内容或你要发送给谁。
中继 3 确切地知道你发送的内容，但它无法确定是谁发送的，因为中继 2 和中继 1 阻止它发现。
所有 3 个中继需要协同工作才能最终连接发送方和目的地。

然而，Tor 对定时攻击很弱，只允许两个参与者在某些位置以便高精度地确定发送者。注意这个 Tor 连接：

> 发送者 <-> S-ISP <-> 中继 1 <-> 中继 2 <-> 中继 3 <-> D-ISP <-> 目的地

如果发送方 ISP(S-ISP) 和目的地一起工作，它们可以记录发送和接收的数据包的大小和时间。
在大量数据包上，它们能够非常精准地确定发送方，实际上，是把数据包发送到目的地的人。
这需要双方进行主动监视或详细记录。
中继 1 也能执行与 S-ISP 相同的角色。

此外，如果底层连接未加密（例如，普通的 HTTP），则可以进行更多配置：

> * S-ISP 和中继 3
> * 中继 1 和中继 3
> * S-ISP 和 D-ISP
> * 中继 1 和 D-ISP

第二个配置总能看到发送方已连接的目标，但如果连接未加密，它们只能看到发送方正在网站上做什么。（路径名在 HTTPS 中加密。）

因为首个中继（入口节点）是连接中的弱点，Tor 采取了一定的防御措施。
当你首次启动 Tor 时，它会选择 3 个在您运行 Tor 的期间内不会更改的入口防护。
除非 1 个失败，否则你将总是使用这 3 个中的 1 个。如果所有的节点都是安全的且你的 ISP 是安全的，那么你就没问题了。

和谐定时攻击对比特币特别重要，因为任何人都能成为连接中的“目的地”。
数据包广播到比特币网络中的每一个对端。这可能让你的 ISP 单独把你的交易与你轻松关联。
但是，定时攻击基于至少从发送方接收接收几十个数据包，所以“目的地”实际上可能必须是是的直接比特币对端之一。
然而，把使用对端淹没比特币网络并不困难。由于这种攻击，使用 Tor 时使用 EWallet 代替比特币客户端是明智之举。

为了发现 Tor 中继，Tor 使用集中式目录服务器模型。有 9 个权威的目录服务器。
要成为中继，你要注册其中之一。目录服务器共享其数据并提供网络状态共识文档，每个文档通常包括所有的 Tor 节点。
Tor 客户端不直连到权威服务器—它们连接到许多目录镜像中的一个，这些镜像具有网络状态共识的副本。
由于 Tor 中没有对等引导机制，如果一半的权威目录服务器被破坏，整个网络就会被破坏，
如果一半的权威目录变坏，整个网络就会被破坏。

隐藏服务允许发送方和目的地保持匿名。隐藏的服务连接如下：

> * 目的地告诉几个 Tor 中继作为隐藏服务的引入点。目的地通过常规的 3 节点 Tor 电路连接到所有这些引入点。
> * 目的地在 Tor DHT 上注册这些引入点。引入点与目标密钥的编码的 SHA-1 哈希的前 16 个字符相关联。这是 .onion 地址中的信息。使用 SHA-1 可能是个弱点。
> * 发送方创建一个 4 节点的 Tor 点入。第 4 个节点称为会合点。
> * 发送方搜索 DHT 中所需隐藏服务的引入点。发送方通过常规的 3 节点 Tor 电路连接到 1 个，并通过引入点告诉目的地它选择的会合点。
> * 目标通过 3 节点 Tor 电路连接到集合点。发送方和目的地现在通过 7 节点连接。

对于客户端，隐藏服务比加密的 Tor HTTPS 连接更安全，因为：

>   * 如果目的地保持匿名，它们就不太可能被坏的一方控制。
> * 目标的 ISP 不参与，因为它们属于 HTTPS 情况。只有这样配置才能定时攻击：
>   * S-ISP 和目的地
>   * 中继 1 和目的地

但是，运行隐藏服务更危险。通过隐藏服务 ISP 可以单独执行交叉攻击：

> * 你的互联网服务被切断。
> * 如果隐藏服务在那个确切的时刻出现问题，那么你会被取消屏蔽。

如上述相同的攻击也是可能的。

Thanks for your time.

## 参照
* [Tor - Bitcoin WiKi](https://en.bitcoin.it/wiki/Tor)
* [Setting up a Tor hidden service - Bitcoin Wiki](https://en.bitcoin.it/wiki/Setting_up_a_Tor_hidden_service)
* [bitcoin/bitcoin v0.12.1](https://github.com/bitcoin/bitcoin/tree/v0.12.1)
* [...](https://github.com/mistydew/blockchain)
