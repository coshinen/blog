---
layout: post
title:  "比特币 RPC 命令剖析 \"verifytxoutproof\""
date:   2018-06-11 11:43:35 +0800
author: mistydew
categories: Blockchain
tags: blockchain bitcoin client rpc
---
![bitcoin](/images/20180504/bitcoin.svg)

## 读在前面
比特币相关的解读目前均采用 [bitcoin v0.12.1](https://github.com/bitcoin/bitcoin/tree/v0.12.1)，此版本为官方内置挖矿算法的最后一版。<br>
目前比特币的最新版本为 bitcoin v0.16.0，离区块链 1.0 落地还有些距离。

## 提示说明

{% highlight shell %}
verifytxoutproof "proof" # 验证指向块上的一笔交易的证明，返回它提交的交易，如果该块不在最佳链上则抛出一个 RPC 错误
{% endhighlight %}

参数：<br>
1. `proof` （字符串，必备）通过 [`gettxoutproof`](/2018/06/11/bitcoin-rpc-command-gettxoutproof) 生成的 16 进制编码的证明。

结果：（数组，字符串）返回证明提交的交易索引集，如果证明无效则为空数组。

## 用法示例

### 比特币核心客户端

先使用 [`gettxoutproof`](/2018/06/11/bitcoin-rpc-command-gettxoutproof) 获取一笔交易的证明，
然后再验证该证明，通过对比返回的交易索引来验证该交易证明。

{% highlight shell %}
$ bitcoin-cli gettxoutproof [\"b797bafd7830774cec4d24d1e649cafb0aa7a67b9f1cc06954102a50b463fa0f\"]
00000020a7bdefd4740678bd9e4b6c6c170dd6ebdfb4dabfb237e428bb4a70f3ae000000ea0a02f07f8f8d9e81792b0068341be05dc20a1d7488b0c34a64c6ed1de72d41b7a3305b538c021e7d5952000200000002ba9ac033f860746a4ab907f918192bf412965e414d84aca52d705131f3b47e570ffa63b4502a105469c01c9f7ba6a70afbca49e6d1244dec4c773078fdba97b70105
$ bitcoin-cli verifytxoutproof 00000020a7bdefd4740678bd9e4b6c6c170dd6ebdfb4dabfb237e428bb4a70f3ae000000ea0a02f07f8f8d9e81792b0068341be05dc20a1d7488b0c34a64c6ed1de72d41b7a3305b538c021e7d5952000200000002ba9ac033f860746a4ab907f918192bf412965e414d84aca52d705131f3b47e570ffa63b4502a105469c01c9f7ba6a70afbca49e6d1244dec4c773078fdba97b70105
[
  "b797bafd7830774cec4d24d1e649cafb0aa7a67b9f1cc06954102a50b463fa0f"
]
{% endhighlight %}

### cURL

{% highlight shell %}
$ curl --user myusername:mypassword --data-binary '{"jsonrpc": "1.0", "id":"curltest", "method": "verifytxoutproof", "params": ["00000020a7bdefd4740678bd9e4b6c6c170dd6ebdfb4dabfb237e428bb4a70f3ae000000ea0a02f07f8f8d9e81792b0068341be05dc20a1d7488b0c34a64c6ed1de72d41b7a3305b538c021e7d5952000200000002ba9ac033f860746a4ab907f918192bf412965e414d84aca52d705131f3b47e570ffa63b4502a105469c01c9f7ba6a70afbca49e6d1244dec4c773078fdba97b70105"] }' -H 'content-type: text/plain;' http://127.0.0.1:8331/
{"result":["b797bafd7830774cec4d24d1e649cafb0aa7a67b9f1cc06954102a50b463fa0f"],"error":null,"id":"curltest"}
{% endhighlight %}

## 源码剖析
`verifytxoutproof` 对应的函数在“rpcserver.h”文件中被引用。

{% highlight C++ %}
extern UniValue verifytxoutproof(const UniValue& params, bool fHelp); // 验证交易证明
{% endhighlight %}

实现在“rpcrawtransaction.cpp”文件中。

{% highlight C++ %}
UniValue verifytxoutproof(const UniValue& params, bool fHelp)
{
    if (fHelp || params.size() != 1) // 参数必须为 1 个
        throw runtime_error( // 命令帮助反馈
            "verifytxoutproof \"proof\"\n"
            "\nVerifies that a proof points to a transaction in a block, returning the transaction it commits to\n"
            "and throwing an RPC error if the block is not in our best chain\n"
            "\nArguments:\n"
            "1. \"proof\"    (string, required) The hex-encoded proof generated by gettxoutproof\n"
            "\nResult:\n"
            "[\"txid\"]      (array, strings) The txid(s) which the proof commits to, or empty array if the proof is invalid\n"
        );

    CDataStream ssMB(ParseHexV(params[0], "proof"), SER_NETWORK, PROTOCOL_VERSION); // 获取指定交易证明初始化数据流对象
    CMerkleBlock merkleBlock;
    ssMB >> merkleBlock; // 导出到 CMerkleBlock 对象中

    UniValue res(UniValue::VARR); // 数组类型的返回对象

    vector<uint256> vMatch; // 用于保存交易索引
    if (merkleBlock.txn.ExtractMatches(vMatch) != merkleBlock.header.hashMerkleRoot) // 提取交易索引列表
        return res;

    LOCK(cs_main); // 上锁

    if (!mapBlockIndex.count(merkleBlock.header.GetHash()) || !chainActive.Contains(mapBlockIndex[merkleBlock.header.GetHash()])) // 区块索引映射列表中包含该区块（头）索引 且 激活的链包含该区块
        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, "Block not found in chain");

    BOOST_FOREACH(const uint256& hash, vMatch) // 遍历交易索引列表
        res.push_back(hash.GetHex()); // 加入结果集
    return res; // 返回结果
}
{% endhighlight %}

基本流程：<br>
1.处理命令帮助和参数个数。<br>
2.获取交易证明，并从该证明中提取交易索引列表。<br>
3.上锁。<br>
4.验证交易所在区块是否为有效区块。<br>
5.遍历交易索引列表，加入结果集并返回。

Thanks for your time.

## 参照
* [Developer Documentation - Bitcoin](https://bitcoin.org/en/developer-documentation)
* [Bitcoin Developer Reference - Bitcoin](https://bitcoin.org/en/developer-reference#verifytxoutproof)
* [精通比特币（第二版） \| 巴比特图书](http://book.8btc.com/masterbitcoin2cn)
* [...](https://github.com/mistydew/blockchain)
